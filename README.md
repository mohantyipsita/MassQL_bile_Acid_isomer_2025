# MassQL_bile_Acid_isomer_2025
This repository contains figures and data files used in the generation of figures and spectral library for the study using MS/MS fragmentation-based MassQL filters to differentiate bile acid isomers. 

**Figure 1. MS/MS fragmentation of bile acid isomers.**
a) Structure of bile acids highlighting mono-, di-, and tri-hydroxylated steroid cores, with experimentally observed potential hydroxylation sites on the steroid core indicated by red stars. b) MS/MS fragmentation spectra of the regioisomers, taurochenodeoxycholic (TCDCA) acid and taurodeoxycholic acid (TDCA), illustrating a low-intensity mass region containing ions unique to each isomer. c) Enlarged view of the MS/MS fragmentation spectra for taurochenodeoxycholic and taurodeoxycholic acids, emphasizing the ion pair used to calculate relative intensity ratios for differentiating these isomers. 

**Figure 2. Development of MS/MS fragmentation-based MassQL filtering tree.**
Sequential MS/MS fragmentation-based filtering tree designed to classify regio- and stereoisomers of dihydroxylated bile acids. Structures at each filtering step are shown, with terminal bins color-coded for clarity. 

**Figure 3. Workflow of MS/MS fragmentation-based MassQL filtering tree.**
Schematic diagram of the workflow for using the multistep MassQL filters for distinguishing different bile acid isomers. 

**Figure 4. Filtering of bile acid isomers in an untargeted LC-MS/MS dataset.**
Representative example for using the MassQL filters for identifying bile acid isomers. a) Overview of study design. Fecal samples from herbivores (n=3), omnivores (n=23), and carnivores (n=13) were analyzed by LC-MS/MS and processed using MZmine4 and FBMN on GNPS2. Stepwise MassQL filtering refined candidate bile acids from 543 features (Step 1) to 96 (Steps 2&3) and 49 stereo and regiochemistry assigned MS/MS spectra (Step 4). Differential abundance of bile acids between herbivores/omnivores and carnivores is illustrated in the volcano plots b) at the Step 1 and c) Step 4 of dihydroxy filtering tree. The annotation of a previously uncharacterized bile acid was refined from (OH)2-N-acetyl-putrescine to 3,12α-N-acetyl-putrescine. 

**Figure 5. Structural elucidation of 3,12α-N-acetyl-putrescine using MassQL filtering and experimental validation.** a) Output from the multi-step MassQL app for the candidate bile acids shown as a sankey plot. The branch with the progressive filtering down from (OH)2-N-acetyl-putrescine to 3,12α-N-acetyl-putrescine is highlighted. The pipeline identified 3,12α-(OH)2 stereochemistry, while showing the potential ambiguity at C3 (α/β).
The isomer assignment of the bile acid core was experimentally validated by b) retention time matching of the synthetic standard of deoxycholyl-N-acetyl-putrescine, biological sample of tiger feces, and spiked sample, confirming co-elution. c) MS/MS spectral comparison of standard with biological extract yielded a cosine similarity of 0.9801. d) The final confirmed structure, deoxycholyl-N-acetyl-putrescine (3α,12α-(OH)2), is shown with regio and stereochemical assignments.

**How to use the Bile acid isomer MassQL queries with LC-MS/MS dataset with the app:** The web-based Multi-step MassQL app allows users to run sequential MassQL queries on the clustered MGF (consensus spectra) generated from GNPS2 Classical or Feature-Based Molecular Networking (CMN/FBMN) jobs. The app can be accessed through the URL: https://multistep-massql.gnps2.org/. It is also accessible from the “Downstream Analysis” section of a CMN/FBMN job in GNPS2. Users provide a GNPS2 Task ID in the app (or use an example dataset), after which the preconfigured bile acid query pipeline automatically runs without manual editing. Results are organized into four interactive tabs: (i) Visualizations, which display a hierarchical bile acid classification tree for each feature; (ii) Classified, which reports feature-level isomer annotations and supporting query matches; (iii) Library Matches, which compares spectra against GNPS spectral libraries to cross-validate MassQL classifications; and (iv) Full Table, which provides a complete record of all consensus spectra with query validation outcomes. The full table can be used for downstream analysis. This streamlined interface ensures reproducible, high-confidence annotation of bile acid isomers directly from untargeted metabolomics datasets.

**How to use the Bile acid isomer MassQL queries with LC-MS/MS dataset:** To use the isomer MassQL queries on any untargeted LC-MS/MS dataset we have provided a custom Python script (see code availability section). Any MGF file containing the list of MS/MS spectra from a LC-MS/MS dataset is provided as an input to this Python script. The output is a .tsv file which provides the list of MS/MS scan numbers captured by each of the MassQL queries. Next we need to apply the sequential binning of the MS/MS scans by traversing each branch of the fragmentation trees to obtain the final scans which fall into one of the terminal bins. [**NOTE**: The sequential binning is critical to reduce false hits. **Please do not skip the this step**]. This step can be done in R or Python script by obtaining the union of the scans from all the isomer groups in each branch of the filtering tree. As an example, for getting MS/MS scans of 3,12α-(OH)2 we need to find the common MS/MS scans obtained in “Dihydroxy”, “3,12α-(OH)2; 7,12α-(OH)2” and “3,12α-(OH)2” steps. We have used this approach in the analysis of the four LC-MS/MS datasets in this study (Figures 2a, 2d-f) and the script called "common_scans" can be found in the folder "BA_isomer_MassQL_filters" deposited to GitHub. Alternatively, the MassQL bile acid isomer library called "GNPS-MASSQL-BILE-ACID-ISOMER" available on GNPS2 as a propagated library can be used while running molecular networking jobs. The documentation to use the library is available at https://wang-bioinformatics-lab.github.io/GNPS2_Documentation/libraries/. However, caution will be needed to manually investigate the spectral matches to ensure the bile acid diagnostic peaks are detected in the MS/MS spectra and annotations will need to be validated by retention time matching with synthetic standards. 
