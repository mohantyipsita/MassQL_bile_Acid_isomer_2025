import pandas as pd
from massql import msql_engine

ALL_MASSQL_QUERIES = {
    
    #monohydroxy
    'Monohydroxy_stage1': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=341.28:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=323.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    'Monohydroxy_stage2' : 'Monohydroxy': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=341.28:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=323.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PREC=X AND MS2PROD=X-358.2871:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    'Mono-3a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=107.086:TOLERANCEPPM=20:INTENSITYPERCENT=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=109.101:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.8:INTENSITYMATCHPERCENT=20",
    'Mono-7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=177.127:TOLERANCEPPM=20:INTENSITYPERCENT=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=241.194:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.2:INTENSITYMATCHPERCENT=30",
    
    # dihydroxy
    'Dihydroxy_stage1': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=339.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=321.26:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    'Dihydroxy_stage2': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=339.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PROD=321.26:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PREC=X AND MS2PROD=X-374.2894:TOLERANCEMZ=0.01:INTENSITYPERCENT=5",
    'Di-1-ketone': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=161.132:TOLERANCEPPM=20:INTENSITYPERCENT=95",
    'Di-3,12a-OH; 7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.6:INTENSITYMATCHPERCENT=80",
    'Di-3,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30",
    'Di-7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.25:INTENSITYMATCHPERCENT=30",
    'Di-3,7-OH; 3,6-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*4.2:INTENSITYMATCHPERCENT=40",
    'Di-3,7-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*2:INTENSITYMATCHPERCENT=20",
    'Di-3,6-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=60",
    'Di-3,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.5:INTENSITYMATCHPERCENT=30",
    'Di-3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20",
    
    #trihydroxy
    'Trihydroxy_stage1': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=337.25:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=319.24:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    'Trihydroxy_stage2': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=337.25:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=319.24:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PREC=X AND MS2PROD=X-390.277:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    'All_ketone_NEW': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=107.086:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=105.07:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.55:INTENSITYMATCHPERCENT=40 AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=X*0.6:INTENSITYMATCHPERCENT=45",
    '3k_7or12_OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=213.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*2:INTENSITYMATCHPERCENT=20" ,
    '3a_12k': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=319.242:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=309.257:TOLERANCEPPM=20:INTENSITYMATCH=Y*5.5:INTENSITYMATCHPERCENT=20" ,
    '3,6,7_NEW': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=191.143:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=225.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.2:INTENSITYMATCHPERCENT=60 AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=213.163:TOLERANCEPPM=20:INTENSITYMATCH=X*0.75:INTENSITYMATCHPERCENT=20",
    '3,7a,12a-OH_NEW': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.6:INTENSITYMATCHPERCENT=45",
    '3,6a,7a-OH' : "QUERY scaninfo(MS2DATA) WHERE MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=185.132:TOLERANCEPPM=20:INTENSITYMATCH=X*1:INTENSITYMATCHPERCENT=5" ,
    '3,6b,7a-OH_3,6a,7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=159.117:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.9:INTENSITYMATCHPERCENT=10",
    '3,6b,7a-OH' : "QUERY scaninfo(MS2DATA) WHERE MS2MZ=125.096:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=309.257:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20"
 
}


def massql_filter(input_mgf, massql_queries=ALL_MASSQL_QUERIES):

    out_df = []
    # process the queries
    for query_name, input_query in massql_queries.items():
        results_df = msql_engine.process_query(input_query, input_mgf)
        if len(results_df) == 0:
            out_df.append({'query': query_name, 'scan_list': 'NA'})
            continue
        passed_scan_ls = results_df['scan'].values.tolist()
        passed_scan_ls = [int(x) for x in passed_scan_ls]
        out_df.append({'query': query_name, 'scan_list': passed_scan_ls})

    # save the result
    out_name = input_mgf.replace('.mgf', '_massql_ALL_NEW.tsv')
    out_df = pd.DataFrame(out_df)
    out_df.to_csv(out_name, sep='\t', index=False)


# actually run the code, a tsv file will be generated in the same folder as mgf
massql_filter(input_mgf='Kine_LP2_others_iimn_fbmn.mgf', massql_queries=ALL_MASSQL_QUERIES)

